{% extends "booking_base.html" %}

{% block title %}Spectator Information - {{ showing.movie_name }} - Cinemacousas{% endblock %}

{% block booking_progress %}
<div class="d-flex align-items-center gap-2">
  <span class="step completed">1. Seats</span>
  <i class="fas fa-chevron-right"></i>
  <span class="step active">2. Info</span>
  <i class="fas fa-chevron-right"></i>
  <span class="step">3. Confirm</span>
</div>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
  <div class="row">
    <!-- Left Column - Movie Information -->
    <div class="col-lg-4">
      <div class="card h-100">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="fas fa-film me-2"></i>
            Movie Information
          </h5>
        </div>
        <div class="card-body">
          <h3 class="card-title mb-3 text-primary">
            {{ showing.movie_name }}
          </h3>
          
          <div class="movie-details">
            <div class="detail-item mb-3">
              <i class="fas fa-calendar text-primary me-2"></i>
              <strong>Date:</strong>
              <div class="ms-4">{{ showing.date.strftime('%A, %B %d, %Y') }}</div>
            </div>
            
            <div class="detail-item mb-3">
              <i class="fas fa-clock text-primary me-2"></i>
              <strong>Time:</strong>
              <div class="ms-4">{{ showing.starttime|seconds_to_time }}</div>
            </div>
            
            <div class="detail-item mb-3">
              <i class="fas fa-door-open text-primary me-2"></i>
              <strong>Room:</strong>
              <div class="ms-4">{{ showing.room_name }}</div>
            </div>
            
            <div class="detail-item mb-3">
              <i class="fas fa-stopwatch text-primary me-2"></i>
              <strong>Duration:</strong>
              <div class="ms-4">{{ showing.duration }} minutes</div>
            </div>
          </div>

          <!-- Selected Seats Summary -->
          <hr>
          <div class="alert alert-info">
            <h6 class="mb-2">
              <i class="fas fa-check-circle me-2"></i>
              Selected Seats:
            </h6>
            <div class="mb-2">
              {% for seat in selected_seats %}
                <span class="badge bg-primary me-1">{{ seat.seat_row }}{{ seat.seat_column }}</span>
              {% endfor %}
            </div>
            <div class="fw-bold">Total: {{ selected_seats|length }} seat(s)</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Column - Spectator Information -->
    <div class="col-lg-8">
      <div class="card h-100">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="fas fa-users me-2"></i>
            Spectator Information
          </h5>
        </div>
        <div class="card-body">
          <!-- Spectator Information Form -->
          <form method="POST" action="{{ url_for('booking_confirm') }}" id="spectatorForm">
            <!-- Hidden fields -->
            <input type="hidden" name="showing_id" value="{{ showing.id }}">
            {% for seat in selected_seats %}
              <input type="hidden" name="selected_seats" value="{{ seat.id }}">
            {% endfor %}

            <!-- Booker Information -->
            <div class="mb-4">
              <h6 class="mb-3">
                <i class="fas fa-user-circle me-2"></i>
                Booker Information
              </h6>
              <div class="row">
                <div class="col-md-4 mb-3">
                  <label for="booker_first_name" class="form-label">First Name *</label>
                  <input type="text" class="form-control" id="booker_first_name" 
                         name="booker_first_name" required>
                </div>
                <div class="col-md-4 mb-3">
                  <label for="booker_last_name" class="form-label">Last Name *</label>
                  <input type="text" class="form-control" id="booker_last_name" 
                         name="booker_last_name" required>
                </div>
                <div class="col-md-4 mb-3">
                  <label for="booker_email" class="form-label">Email *</label>
                  <input type="email" class="form-control" id="booker_email" 
                         name="booker_email" required>
                </div>
              </div>
            </div>

            <hr>

            <!-- Spectators Information -->
            <div class="mb-4">
              <h6 class="mb-3">
                <i class="fas fa-users me-2"></i>
                Spectator Details
              </h6>
              
              {% for i in range(num_spectators) %}
                <div class="spectator-section mb-4" data-spectator="{{ i }}">
                  <div class="d-flex align-items-center mb-3">
                    <div class="seat-badge me-3">
                      {{ selected_seats[i].seat_row }}{{ selected_seats[i].seat_column }}
                    </div>
                    <h6 class="mb-0">Spectator {{ i + 1 }}</h6>
                  </div>
                  
                  <div class="row">
                    <div class="col-md-3 mb-3">
                      <label for="spectator_{{ i }}_first_name" class="form-label">First Name *</label>
                      <input type="text" class="form-control" 
                             id="spectator_{{ i }}_first_name" 
                             name="spectator_{{ i }}_first_name" required>
                    </div>
                    <div class="col-md-3 mb-3">
                      <label for="spectator_{{ i }}_last_name" class="form-label">Last Name *</label>
                      <input type="text" class="form-control" 
                             id="spectator_{{ i }}_last_name" 
                             name="spectator_{{ i }}_last_name" required>
                    </div>
                    <div class="col-md-3 mb-3">
                      <label for="spectator_{{ i }}_birth_date" class="form-label">Birth Date *</label>
                      <input type="date" class="form-control" 
                             id="spectator_{{ i }}_birth_date" 
                             name="spectator_{{ i }}_birth_date" required>
                    </div>
                    <div class="col-md-3 mb-3">
                      <div class="form-check mt-4">
                        <input class="form-check-input" 
                               type="checkbox" 
                               id="spectator_{{ i }}_pmr" 
                               name="spectator_{{ i }}_pmr">
                        <label class="form-check-label" for="spectator_{{ i }}_pmr">
                          Person with Reduced Mobility (PMR)
                        </label>
                      </div>
                    </div>
                  </div>
                  
                  {% if not loop.last %}
                    <hr class="my-4">
                  {% endif %}
                </div>
              {% endfor %}
            </div>

            <!-- Price Summary -->
            <hr>
            <div class="mb-4">
              <div class="d-flex justify-content-between align-items-center">
                <h6 class="mb-0">Total Price:</h6>
                <div class="h4 text-primary fw-bold" id="totalPrice">€{{ "%.2f"|format(showing.baseprice * num_spectators) }}</div>
              </div>
              <div class="mt-2 small text-muted" id="priceBreakdown">
                {{ num_spectators }} tickets × €{{ "%.2f"|format(showing.baseprice) }} = €{{ "%.2f"|format(showing.baseprice * num_spectators) }}
              </div>
            </div>

            <!-- Action Buttons -->
            <div class="d-flex justify-content-between mt-4">
              <a href="{{ url_for('showing_seats', showing_id=showing.id) }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>
                Back to Seat Selection
              </a>
              <button type="submit" class="btn btn-primary btn-lg" id="confirmBtn">
                <i class="fas fa-check me-2"></i>
                Confirm Booking
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.progress-container {
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 20px 0;
}

.progress-step {
  display: flex;
  flex-direction: column;
  align-items: center;
  position: relative;
}

.step-circle {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background-color: #e9ecef;
  color: #6c757d;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  margin-bottom: 8px;
  border: 2px solid #e9ecef;
  transition: all 0.3s ease;
}

.step-label {
  font-size: 12px;
  color: #6c757d;
  text-align: center;
}

.progress-step.completed .step-circle {
  background-color: #28a745;
  border-color: #28a745;
  color: white;
}

.progress-step.completed .step-label {
  color: #28a745;
}

.progress-step.active .step-circle {
  background-color: #007bff;
  border-color: #007bff;
  color: white;
}

.progress-step.active .step-label {
  color: #007bff;
}

.progress-line {
  width: 100px;
  height: 2px;
  background-color: #e9ecef;
  margin: 0 20px;
  margin-top: -28px;
}

.seat-badge {
  background-color: #007bff;
  color: white;
  padding: 8px 12px;
  border-radius: 6px;
  font-weight: bold;
  font-size: 14px;
}

.spectator-section {
  position: relative;
}

.selected-seats-info .badge {
  font-size: 14px;
  padding: 8px 12px;
}
</style>

<script>
// Auto-populate booker info for first spectator
function populateFirstSpectator() {
  const bookerFirstName = document.getElementById('booker_first_name');
  const bookerLastName = document.getElementById('booker_last_name');
  const spectator0FirstName = document.getElementById('spectator_0_first_name');
  const spectator0LastName = document.getElementById('spectator_0_last_name');
  
  if (spectator0FirstName && spectator0LastName) {
    bookerFirstName.addEventListener('input', function() {
      if (!spectator0FirstName.value) {
        spectator0FirstName.value = this.value;
      }
    });
    
    bookerLastName.addEventListener('input', function() {
      if (!spectator0LastName.value) {
        spectator0LastName.value = this.value;
      }
    });
  }
}

// Initialize the page
document.addEventListener('DOMContentLoaded', function() {
  populateFirstSpectator();
});
</script>
{% endblock %}
