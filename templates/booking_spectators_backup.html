{% extends "base.html" %}

{% block title %}Spectator Information - {{ showing.movie_name }} - Cinemacousas{% endblock %}

{% block content %}
<div class="container mt-4">
  <!-- Booking Progress -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="progress-container">
        <div class="progress-step completed">
          <div class="step-circle">1</div>
          <div class="step-label">Select Seats</div>
        </div>
        <div class="progress-line"></div>
        <div class="progress-step active">
          <div class="step-circle">2</div>
          <div class="step-label">Spectator Info</div>
        </div>
        <div class="progress-line"></div>
        <div class="progress-step">
          <div class="step-circle">3</div>
          <div class="step-label">Confirmation</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Movie and Showing Info -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <div class="row align-items-center">
            <div class="col-md-6">
              <h5 class="card-title mb-2">
                <i class="fas fa-film me-2 text-primary"></i>
                {{ showing.movie_name }}
              </h5>
              <div class="d-flex flex-wrap gap-3 text-muted small">
                <span>
                  <i class="fas fa-calendar me-1"></i>
                  {{ showing.date.strftime('%A, %B %d, %Y') }}
                </span>
                <span>
                  <i class="fas fa-clock me-1"></i>
                  {{ (showing.starttime|int / 3600)|int }}:{{ '%02d'|format(((showing.starttime|int % 3600) / 60)|int) }}
                </span>
                <span>
                  <i class="fas fa-door-open me-1"></i>
                  {{ showing.room_name }}
                </span>
              </div>
            </div>
            <div class="col-md-6 text-md-end">
              <div class="selected-seats-info">
                <h6 class="mb-1">Selected Seats:</h6>
                <div class="badge bg-primary">
                  {% for seat in selected_seats %}
                    {{ seat.seat_row }}{{ seat.seat_column }}{% if not loop.last %}, {% endif %}
                  {% endfor %}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Spectator Information Form -->
  <form method="POST" action="{{ url_for('booking_confirm') }}" id="spectatorForm">
    <!-- Hidden fields -->
    <input type="hidden" name="showing_id" value="{{ showing.id }}">
    {% for seat in selected_seats %}
      <input type="hidden" name="selected_seats" value="{{ seat.id }}">
    {% endfor %}

    <!-- Booker Information -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card">
          <div class="card-body">
            <div class="row">
              <div class="col-md-4 mb-3">
                <label for="booker_first_name" class="form-label">First Name *</label>
                <input type="text" class="form-control" id="booker_first_name" 
                       name="booker_first_name" required>
              </div>
              <div class="col-md-4 mb-3">
                <label for="booker_last_name" class="form-label">Last Name *</label>
                <input type="text" class="form-control" id="booker_last_name" 
                       name="booker_last_name" required>
              </div>
              <div class="col-md-4 mb-3">
                <label for="booker_email" class="form-label">Email *</label>
                <input type="email" class="form-control" id="booker_email" 
                       name="booker_email" required>
                <div class="form-text">We'll send your tickets to this email address.</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Spectators Information -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card">
          <div class="card-body">
            {% for i in range(num_spectators) %}
              <div class="spectator-section mb-4" data-spectator="{{ i }}">
                <div class="d-flex align-items-center mb-3">
                  <div class="seat-badge me-3">
                    {{ selected_seats[i].seat_row }}{{ selected_seats[i].seat_column }}
                  </div>
                  <h6 class="mb-0">Spectator {{ i + 1 }}</h6>
                </div>
                
                <div class="row">
                  <div class="col-md-3 mb-3">
                    <label for="spectator_{{ i }}_first_name" class="form-label">First Name *</label>
                    <input type="text" class="form-control" 
                           id="spectator_{{ i }}_first_name" 
                           name="spectator_{{ i }}_first_name" required>
                  </div>
                  <div class="col-md-3 mb-3">
                    <label for="spectator_{{ i }}_last_name" class="form-label">Last Name *</label>
                    <input type="text" class="form-control" 
                           id="spectator_{{ i }}_last_name" 
                           name="spectator_{{ i }}_last_name" required>
                  </div>
                  <div class="col-md-3 mb-3">
                    <label for="spectator_{{ i }}_birth_date" class="form-label">Birth Date *</label>
                    <input type="date" class="form-control" 
                           id="spectator_{{ i }}_birth_date" 
                           name="spectator_{{ i }}_birth_date" 
                           onchange="updatePricing({{ i }})" required>
                  </div>
                  <div class="col-md-3 mb-3">
                    <label for="spectator_{{ i }}_age_price_id" class="form-label">Ticket Type *</label>
                    <select class="form-select" 
                            id="spectator_{{ i }}_age_price_id" 
                            name="spectator_{{ i }}_age_price_id" 
                            onchange="updateTotalPrice()" required>
                      <option value="">Select ticket type</option>
                      {% for age_price in age_pricing %}
                        <option value="{{ age_price.id }}" data-price="{{ "%.2f"|format((showing.baseprice / 100) * age_price.factor) }}">
                          {{ age_price.name }} - €{{ "%.2f"|format((showing.baseprice / 100) * age_price.factor) }}
                        </option>
                      {% endfor %}
                    </select>
                  </div>
                </div>
                
                {% if not loop.last %}
                  <hr class="my-4">
                {% endif %}
              </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>

    <!-- Price Summary -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <h5 class="mb-0">Total Price:</h5>
              <div class="display-6 text-primary fw-bold" id="totalPrice">€0.00</div>
            </div>
            <div class="mt-2 small text-muted" id="priceBreakdown"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="d-flex justify-content-between">
          <a href="{{ url_for('showing_seats', showing_id=showing.id) }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>
            Back to Seat Selection
          </a>
          <button type="submit" class="btn btn-primary btn-lg" id="confirmBtn">
            <i class="fas fa-check me-2"></i>
            Confirm Booking
          </button>
        </div>
      </div>
    </div>
  </form>
</div>

<style>
.progress-container {
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 20px 0;
}

.progress-step {
  display: flex;
  flex-direction: column;
  align-items: center;
  position: relative;
}

.step-circle {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background-color: #e9ecef;
  color: #6c757d;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  margin-bottom: 8px;
  border: 2px solid #e9ecef;
  transition: all 0.3s ease;
}

.step-label {
  font-size: 12px;
  color: #6c757d;
  text-align: center;
}

.progress-step.completed .step-circle {
  background-color: #28a745;
  border-color: #28a745;
  color: white;
}

.progress-step.completed .step-label {
  color: #28a745;
}

.progress-step.active .step-circle {
  background-color: #007bff;
  border-color: #007bff;
  color: white;
}

.progress-step.active .step-label {
  color: #007bff;
}

.progress-line {
  width: 100px;
  height: 2px;
  background-color: #e9ecef;
  margin: 0 20px;
  margin-top: -28px;
}

.seat-badge {
  background-color: #007bff;
  color: white;
  padding: 8px 12px;
  border-radius: 6px;
  font-weight: bold;
  font-size: 14px;
}

.spectator-section {
  position: relative;
}

.selected-seats-info .badge {
  font-size: 14px;
  padding: 8px 12px;
}

#confirmBtn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}
</style>

<script>
const agePricing = {{ age_pricing|tojson }};
const basePrice = {{ showing.baseprice / 100 }}; // Convert cents to euros

function updatePricing(spectatorIndex) {
  const birthDateInput = document.getElementById(`spectator_${spectatorIndex}_birth_date`);
  const priceSelect = document.getElementById(`spectator_${spectatorIndex}_age_price_id`);
  
  if (!birthDateInput.value) {
    return;
  }
  
  const birthDate = new Date(birthDateInput.value);
  const today = new Date();
  const age = Math.floor((today - birthDate) / (365.25 * 24 * 60 * 60 * 1000));
  
  // Find the appropriate age pricing
  let selectedPriceId = null;
  for (const agePrice of agePricing) {
    if (age >= agePrice.agemin && (agePrice.agemax === null || age <= agePrice.agemax)) {
      selectedPriceId = agePrice.id;
      break;
    }
  }
  
  if (selectedPriceId) {
    priceSelect.value = selectedPriceId;
    updateTotalPrice();
  }
}

function updateTotalPrice() {
  let total = 0;
  const breakdown = [];
  
  const spectatorSections = document.querySelectorAll('.spectator-section');
  spectatorSections.forEach((section, index) => {
    const priceSelect = section.querySelector('select[name$="_age_price_id"]');
    const selectedOption = priceSelect.selectedOptions[0];
    
    if (selectedOption && selectedOption.value) {
      const price = parseFloat(selectedOption.getAttribute('data-price'));
      const finalPrice = basePrice + price;
      total += finalPrice;
      
      const firstName = section.querySelector('input[name$="_first_name"]').value || `Spectator ${index + 1}`;
      breakdown.push(`${firstName}: €${finalPrice.toFixed(2)}`);
    }
  });
  
  document.getElementById('totalPrice').textContent = `€${total.toFixed(2)}`;
  document.getElementById('priceBreakdown').textContent = breakdown.join(' + ');
}

// Auto-populate booker info for first spectator
function populateFirstSpectator() {
  const bookerFirstName = document.getElementById('booker_first_name');
  const bookerLastName = document.getElementById('booker_last_name');
  const spectator0FirstName = document.getElementById('spectator_0_first_name');
  const spectator0LastName = document.getElementById('spectator_0_last_name');
  
  bookerFirstName.addEventListener('input', function() {
    if (!spectator0FirstName.value) {
      spectator0FirstName.value = this.value;
    }
  });
  
  bookerLastName.addEventListener('input', function() {
    if (!spectator0LastName.value) {
      spectator0LastName.value = this.value;
    }
  });
}

// Form validation
function validateForm() {
  const form = document.getElementById('spectatorForm');
  const confirmBtn = document.getElementById('confirmBtn');
  
  function checkFormValidity() {
    const isValid = form.checkValidity();
    confirmBtn.disabled = !isValid;
  }
  
  // Check form validity on input changes
  form.addEventListener('input', checkFormValidity);
  form.addEventListener('change', checkFormValidity);
  
  // Initial check
  checkFormValidity();
}

// Initialize the page
document.addEventListener('DOMContentLoaded', function() {
  populateFirstSpectator();
  validateForm();
  updateTotalPrice();
});
</script>
{% endblock %}
