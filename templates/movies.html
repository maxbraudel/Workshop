<!-- templates/movies.html -->
{% extends "base.html" %}

{% block title %}Movies - Cinemacousas{% endblock %}

{% block content %}
<div class="container mt-4">
  <!-- Calendar Strip -->
  <div class="row mb-4">
    <div class="col-12">
      <h2 class="mb-3">
        <i class="fas fa-film me-2"></i>
        Current Movies
      </h2>
      
      <!-- Date Carousel -->
      <div class="date-carousel-container position-relative">
        <!-- Left Arrow -->
        <button id="prevBtn" class="carousel-nav-btn position-absolute start-0 top-50 translate-middle-y d-flex align-items-center justify-content-center" style="z-index: 10;">
          <i class="fas fa-chevron-left text-secondary"></i>
        </button>
        
        <!-- Date Carousel -->
        <div class="date-carousel overflow-hidden mx-3">
          <div class="date-carousel-track d-flex transition-transform" id="dateCarousel" style="transition: transform 0.3s ease;">
            <!-- Dates will be generated by JavaScript -->
          </div>
        </div>
        
        <!-- Right Arrow -->
        <button id="nextBtn" class="carousel-nav-btn position-absolute end-0 top-50 translate-middle-y d-flex align-items-center justify-content-center" style="z-index: 10;">
          <i class="fas fa-chevron-right text-secondary"></i>
        </button>
        
        <!-- Calendar Button -->
        <button id="calendarBtn" class="carousel-nav-btn position-absolute bg-white border border-secondary rounded d-flex align-items-center justify-content-center" style="z-index: 10; right: -50px; top: 50%; transform: translateY(-50%);">
          <i class="fas fa-calendar-alt text-secondary"></i>
        </button>
        
        <!-- Calendar Picker (Hidden by default) -->
        <div id="calendarPicker" class="position-absolute bg-white border rounded shadow-lg p-3" style="top: 100%; right: -50px; z-index: 20; display: none; min-width: 250px;">
          <input type="date" id="datePicker" class="form-control">
          <div class="mt-2 d-flex justify-content-end gap-2">
            <button id="cancelDate" class="btn btn-sm btn-outline-secondary">Cancel</button>
            <button id="selectDate" class="btn btn-sm btn-primary">Select</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="row">
    <div class="col-12">
      
      {% if movies %}
        <div class="row">
          {% for movie in movies %}
            <div class="col-12 col-md-6 mb-4">
              <div class="card movie-card h-100 shadow-sm border-0">
                <div class="card-body d-flex flex-column">
                  <!-- Movie Title -->
                  <h5 class="card-title fw-bold text-primary mb-2">
                    {{ movie.name }}
                  </h5>
                  
                  <!-- Duration Badge -->
                  <div class="mb-3">
                    <span class="badge bg-secondary">
                      <i class="fas fa-clock me-1"></i>
                      {{ movie.duration }} min
                    </span>
                  </div>
                  
                  <!-- Director -->
                  <p class="mb-2">
                    <strong>Directed by:</strong> 
                    <span class="text-muted">{{ movie.director }}</span>
                  </p>
                  
                  <!-- Cast -->
                  <p class="mb-3">
                    <strong>Cast:</strong> 
                    <span class="text-muted">{{ movie.cast }}</span>
                  </p>
                  
                  <!-- Synopsis -->
                  <div class="mt-auto">
                    <h6 class="fw-bold mb-2">Synopsis</h6>
                    <p class="card-text text-muted small">
                      {{ movie.synopsis }}
                    </p>
                  </div>
                  
                  <!-- Action Buttons -->
                  <div class="mt-3 pt-3 border-top">
                    <h6 class="fw-bold mb-2">Available Showings</h6>
                    <div class="showings-container" data-movie-id="{{ movie.id }}">
                      <p class="text-muted small mb-0">
                        <i class="fas fa-info-circle me-1"></i>
                        Select a date to see available showtimes
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="alert alert-info text-center">
          <i class="fas fa-film fa-2x mb-3"></i>
          <h4>No Movies Available</h4>
          <p class="mb-0">Check back later for new movie releases!</p>
        </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const dateCarousel = document.getElementById('dateCarousel');
    const showingsContainers = document.querySelectorAll('.showings-container');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const calendarBtn = document.getElementById('calendarBtn');
    const calendarPicker = document.getElementById('calendarPicker');
    const datePicker = document.getElementById('datePicker');
    const cancelDate = document.getElementById('cancelDate');
    const selectDate = document.getElementById('selectDate');
    
    // Movies data with showings
    const moviesData = {{ movies|tojson }};
    console.log('Movies data:', moviesData);
    
    let currentOffset = 0;
    let selectedDate = null;
    const dateButtons = [];
    
    // Generate dates for the next 16 days
    function generateDates() {
        const dates = [];
        const today = new Date();
        
        for (let i = 0; i < 16; i++) {
            const date = new Date(today);
            date.setDate(today.getDate() + i);
            dates.push(date);
        }
        
        return dates;
    }
    
    // Format date for display
    function formatDisplayDate(date, index) {
        const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        
        if (index === 0) {
            return {
                dayName: 'Today',
                dayNumber: '',
                monthName: '',
                fullDate: date.toISOString().split('T')[0]
            };
        } else if (index === 1) {
            return {
                dayName: 'Tomorrow',
                dayNumber: '',
                monthName: '',
                fullDate: date.toISOString().split('T')[0]
            };
        } else {
            return {
                dayName: days[date.getDay()],
                dayNumber: date.getDate(),
                monthName: months[date.getMonth()],
                fullDate: date.toISOString().split('T')[0]
            };
        }
    }
    
    // Format time from timedelta object or seconds
    function formatTime(timeData) {
        let totalSeconds;
        
        // Handle different time formats
        if (typeof timeData === 'object' && timeData.seconds !== undefined) {
            totalSeconds = timeData.seconds;
        } else if (typeof timeData === 'number') {
            totalSeconds = timeData;
        } else if (typeof timeData === 'string') {
            // Handle HH:MM:SS format
            const parts = timeData.split(':');
            totalSeconds = parseInt(parts[0]) * 3600 + parseInt(parts[1]) * 60 + parseInt(parts[2]);
        } else {
            console.log('Unknown time format:', timeData);
            return '00:00';
        }
        
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        return String(hours).padStart(2, '0') + ':' + String(minutes).padStart(2, '0');
    }
    
    // Create date buttons
    function createDateButtons() {
        const dates = generateDates();
        dateCarousel.innerHTML = '';
        dateButtons.length = 0;
        
        dates.forEach((date, index) => {
            const dateInfo = formatDisplayDate(date, index);
            const isToday = index === 0;
            
            const dateButton = document.createElement('button');
            dateButton.className = `me-2 flex-shrink-0 date-btn ${isToday ? 'active' : ''}`;
            dateButton.dataset.date = dateInfo.fullDate;
            dateButton.style.minWidth = '120px';
            
            if (index <= 1) {
                // Today and Tomorrow
                dateButton.innerHTML = `
                    <div class="d-flex flex-column align-items-center justify-content-center h-100">
                        <div class="fw-bold">${dateInfo.dayName}</div>
                    </div>
                `;
            } else {
                // Other days
                dateButton.innerHTML = `
                    <div class="d-flex flex-column align-items-center justify-content-center h-100">
                        <div class="small text-uppercase">${dateInfo.dayName}</div>
                        <div class="fw-bold">${dateInfo.dayNumber}</div>
                        <div class="small">${dateInfo.monthName}</div>
                    </div>
                `;
            }
            
            dateButton.addEventListener('click', () => selectDateHandler(dateInfo.fullDate, dateButton));
            dateCarousel.appendChild(dateButton);
            dateButtons.push(dateButton);
        });
        
        // Select today by default
        const todayButton = dateCarousel.querySelector('.date-btn.active');
        if (todayButton) {
            selectedDate = todayButton.dataset.date;
            selectDateHandler(selectedDate, todayButton);
        }
    }
    
    // Handle carousel navigation
    function updateCarousel() {
        const buttonWidth = 120 + 8; // button width + margin
        const maxOffset = Math.max(0, (dateButtons.length - 4) * buttonWidth);
        
        currentOffset = Math.max(0, Math.min(currentOffset, maxOffset));
        dateCarousel.style.transform = `translateX(-${currentOffset}px)`;
        
        // Update button states
        prevBtn.disabled = currentOffset === 0;
        nextBtn.disabled = currentOffset >= maxOffset;
    }
    
    // Previous button handler
    prevBtn.addEventListener('click', () => {
        const buttonWidth = 120 + 8;
        currentOffset = Math.max(0, currentOffset - buttonWidth * 2);
        updateCarousel();
    });
    
    // Next button handler
    nextBtn.addEventListener('click', () => {
        const buttonWidth = 120 + 8;
        const maxOffset = Math.max(0, (dateButtons.length - 4) * buttonWidth);
        currentOffset = Math.min(maxOffset, currentOffset + buttonWidth * 2);
        updateCarousel();
    });
    
    // Calendar button handler
    calendarBtn.addEventListener('click', () => {
        const isVisible = calendarPicker.style.display !== 'none';
        calendarPicker.style.display = isVisible ? 'none' : 'block';
        
        if (!isVisible) {
            datePicker.value = selectedDate || new Date().toISOString().split('T')[0];
        }
    });
    
    // Calendar picker handlers
    cancelDate.addEventListener('click', () => {
        calendarPicker.style.display = 'none';
    });
    
    selectDate.addEventListener('click', () => {
        const pickedDate = datePicker.value;
        if (pickedDate) {
            // Find if the date exists in our buttons
            const existingButton = dateButtons.find(btn => btn.dataset.date === pickedDate);
            if (existingButton) {
                selectDateHandler(pickedDate, existingButton);
            } else {
                // Create a new selection for dates outside the 16-day range
                selectedDate = pickedDate;
                document.querySelectorAll('.date-btn').forEach(btn => btn.classList.remove('active'));
                updateShowings(pickedDate);
            }
        }
        calendarPicker.style.display = 'none';
    });
    
    // Close calendar picker when clicking outside
    document.addEventListener('click', (e) => {
        if (!calendarBtn.contains(e.target) && !calendarPicker.contains(e.target)) {
            calendarPicker.style.display = 'none';
        }
    });
    
    // Select a date and update showings
    function selectDateHandler(selectedDateValue, buttonElement) {
        selectedDate = selectedDateValue;
        
        // Update active button
        document.querySelectorAll('.date-btn').forEach(btn => btn.classList.remove('active'));
        buttonElement.classList.add('active');
        
        updateShowings(selectedDateValue);
    }
    
    function updateShowings(selectedDateValue) {
        // Update showings for each movie
        showingsContainers.forEach(container => {
            const movieId = parseInt(container.dataset.movieId);
            const movie = moviesData.find(m => m.id === movieId);
            
            if (movie && movie.showings) {
                const showingsForDate = movie.showings.filter(showing => {
                    const showingDate = new Date(showing.date).toISOString().split('T')[0];
                    return showingDate === selectedDateValue;
                });
                
                if (showingsForDate.length > 0) {
                    container.innerHTML = `
                        <div class="d-flex flex-wrap gap-2">
                            ${showingsForDate.map(showing => `
                                <button class="btn btn-outline-primary btn-sm showing-time-btn">
                                    <i class="fas fa-clock me-1"></i>
                                    ${formatTime(showing.starttime)}
                                </button>
                            `).join('')}
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <p class="text-muted small mb-0">
                            <i class="fas fa-info-circle me-1"></i>
                            No showings available for this date
                        </p>
                    `;
                }
            }
        });
    }
    
    // Initialize the carousel
    createDateButtons();
    updateCarousel();
});
</script>
{% endblock %}
